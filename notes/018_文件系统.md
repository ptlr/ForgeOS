# <h1 align="center">018 文件系统</h1>

## 一、文件系统

### 1.1 文件系统简介

对大多数用户来说，文件系统是最明显的部分。它提供机制，以便用户对计算机上的数据（可以是操作系统本身，比如加载，也可以是数据和程序）进行访问进行访问。

文件系统有两个不同的组成部分，分别是文件集合和目录结构：

* 文件集合：存储文件相关的数据，比如：权限。

* 目录结构：组织系统的的所有文件并提供文件信息。 

### 1.2 文件简介

计算机可以在各种存储介质（磁盘、磁带、光盘）上存储信息。为方便访问数据，操作系统对存储设备的物理属性加以抽象，从而定义逻辑存储单位，`文件（File）`。

文件是记录在外存上的相关信息组合，它的信息由创建这定义。

### 1.3 目录简介

操作系统设计的目的是让用户方便的利用计算机资源，文件系统也不例外，相比于计算机所处的底层数据，由文字标识（文件名）的文件更容易使用。

可以把文件名作为文件的信息保存在文件的信息集中，但计算机中的文件成千上万，甚至对于多用户操作系统，还有权限控制，需要引入一种结构来组织和管理文件，用于关联文件名与文件和访问文件。

## 二、文件系统的实现

存储介质(硬盘)是低速设备，为避免频繁地访问硬盘，需要把数据积攒到一定大小再写入存储介质，这个大小称为块，一般是扇区大小的整数倍，如4KiB, 32KiB等。

在学习过程中，采用UINX操作系统的索引结构----inode。

### 2.1 索引结点（inode）

将文件以索引结构来组织，避免了访问某一数据时需要从头把在它之前的文件遍历以便，比如FAT文件系统。

文件系统为了实现文件管理方案，需要一些辅助管理的数据结构，只要是用于管理、控制文件信息的数据结构都称为`文件控制块`（File Contrl Block， FCB)。

索引结点（inode）中存储了用于管理、控制文件的信息，因此inode也是FCB的一种。

每个inode就表示一个文件。

#### 2.1.1 inode数据结构（采用该结构作为FCB）

| 数据描述       | 数据大小   | 备注       |
|:----------:|:------:| -------- |
| inode编号    | uint32 |          |
| 最后更新时间     | uint32 |          |
| 创建时间       | uint32 |          |
| 文件大小       | uint32 |          |
| 打开次数       | uint32 |          |
| 写控制        | bool   | 写操作时不能并行 |
| ······     | ······ |          |
| 12个直接块指针   | uint32 | 支持       |
| 一级间接块索引表指针 | uint32 | 支持       |
| 二级间接块索引表指针 | uint32 |          |
| 三级间接块索引表指针 | uint32 |          |

在学习的过程中，只实现表中的功能，因此着重介绍索引表。

inode中最后有15项 x 4字节大小的数据用来存储块索引表，说明过程中块大小取512字节。

* 直接索引块指针

共有12个，直接指向数据块，只用这12个直接索引指针时，可存储12个块的数据大小。

* 一级间接索引指针

当12个`直接索引指针`不够保存数据时，可以使用二级间接索引指针增加128个块。

此时，每个文件大小是：12 + 128 = 140个块。

* 二级间接索引块指针

以此类推，加上二级索引块指针时，可存储的文件大小应该是：12 + 128 + 128 x 128 = 16524个块。

* 三级间接索引块指针

以此类推，加上二级索引块指针时，可存储的文件大小应该是：12 + 128 + 128 x 128  + 128 x 128 x 128个块。

```
可存储的块大小计算方式：
每块存储的块指针数 = 每块大小 / inode编号大小
总块数 = 12 + 每块存储的块指针数^1 + 每块存储的块指针数^2 + 每块存储的块指针数^3
```

#### 2.1.2 目录结构

在inode中，目录也是文件，但它的数据单位是`目录项`，根据文件系统的功能情况，`目录项`中记录数据也不同。

在学习的过程中目录项设计如下：

| 数据项     | 数据长度   | 备注                     |
| ------- | ------ | ---------------------- |
| inode编号 | uint32 |                        |
| 文件名     | 192字节  | 在UTF-8格式下，预计可存储64个中文字符 |
| 文件类型    |        | 未知、目录、普通文件             |

#### 2.1.3 目录访问

为了找到所需要访问的文件，需要一个根目录，在*uinx中，根目录是`/`。

### 2.2 超级块

在设计文件系统的过程中，需要知道inode被保存在了哪里，它的长度以及一些其他信息，用作该分区的入口，把这个数据结构叫做超级块（Super Block）

把他放在OBR后的扇区（又或者块）里，后面保存一些用于管理分区的数据。

### 2.3 分区结构

| 数据      | 描述   |
|:-------:|:---- |
| OBR     | 一个扇区 |
| 超级块     |      |
| 空闲块位图   |      |
| inode位图 |      |
| inode数组 |      |
| 根目录     |      |
| 空闲区域    |      |
