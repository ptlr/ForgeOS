# <h1 align="center">N01 BootLoader</h1>

## 一、计算机启动过程

计算机的启动是一个复杂的过程。经过演变，目前主流是UEFI的启动方式。在学习操作系统的过程中，在虚拟机中使用传统模式（Legacy）为主，移植到实机上使用UEFI或者考虑启动管理器。

### 1、传统（legacy）启动过程

| 启动步骤                               | 描述                                                           | 备注                           |
| ---------------------------------- | ------------------------------------------------------------ | ---------------------------- |
| 1、读取BIOS(Base Input/Output System) | 按下开机键后，从ROM中读取BIOS                                           |                              |
| 2、POST(Power-On Self-Test)         | BIOS程序开始检查计算机硬件是否满足运行条件，不满足则发出蜂鸣，启动终止。                       | 现在一下高端主板还会带有DEBUG灯。          |
| 3、加载主引导记录（MBR）                     | BIOS程序会根据引导顺序查找能启动的存储器（软盘/硬盘），并把有启动标志(0x55AA)的前512B加载到0x7c00 | 实际情况会更复杂，比如主分区，扩展分区，启动管理器等等。 |
| 4、加载loader                         | 主引导记录负责把操作系统的loader，加载进内存。loader负责加载内核，查询操作系统用到的硬件信息。        |                              |
| 5、操作系统                             | loader完成任务后，跳转到kernel,由kernel执行初始化和管理硬件资源                    |                              |

### 2、UEFI

// ToDo

### 3、启动管理器

// ToDo

## 二、软盘操作

[BIOS存储器操作参考资料](http://www.ctyme.com/intr/int-13.htm)

BIOS为开发者提供了软盘/硬盘的读写操作中断，中断号是`13H`，2号子功能是读取存储器的操作，具体入口如下：

```
（ah）=子功能号
（al）=读取的扇区数
（ch）=磁道号
（cl）=扇区号
（dh）=磁头号（对去软盘来说就是面号）
（dl）=驱动器号。软驱从0H开始，0h表示软盘A,1H表示软盘B;硬盘从80H开始，80H表示硬盘C,81H表示硬盘D

返回参数：
成功：（AH）=0, (AL)=读取的扇区数
失败：（AH）=出错代码
```

在中断程序中，读取需要面号，磁道号，扇区号，不太方便。对于1.44MB的磁盘来说，共2880个扇区，为这2880个扇区从0~2879进行编号，称为逻辑扇区。

对应关系如下所示：

| 物理扇区号       | 逻辑扇区号  |
|:-----------:|:------:|
| 0面， 0道， 1扇区 | 0      |
| 0面， 0道， 2扇区 | 1      |
| 0面， 0道， 3扇区 | 2      |
| ......      | ...... |
| 0面， 0道，18扇区 | 17     |
| 1面， 0道， 1扇区 | 18     |
| 1面， 0道， 2扇区 | 19     |
| 1面， 0道， 3扇区 | 20     |
| ......      | ...... |
| 1面， 0道，18扇区 | 35     |
| 0面， 1道， 1扇区 | 36     |
| ......      | ...... |
| 0面， 1道，18扇区 | 53     |
| 0面， 1道， 1扇区 | 54     |
| ......      | ...... |
| 1面，79道，18扇区 | 2879   |

```
逻辑扇区号=（磁道号 * 2 + 磁头号（面号）） * 18 + 扇区号 - 1
```

因此可以得出逻辑扇区号到磁头号（面号）、磁道号、扇区号的转换过程：

```
# 启动`/`表示求商，'%'表示求余数
面号=（逻辑扇区号 / 18） % 2
磁道号=（逻辑扇区号 / 18） / 2
扇区号=（逻辑扇区号 % 18）+ 1
```

## 三、文字模式下显示字符串

[BIOS显示操作相关](http://www.ctyme.com/intr/int-10.htm)

BIOS中断程序也提供了文字显示功能。int 10H提供了相应的功能。

启动00H子功能提供了视频模式的设置。在学习并开发图形界面前，选择03H模式，该模式能显示80（列）*25（行） 16色的文字模式。它的起始位置是0xB800,可以显示8页，

默认情况下显示第一页。