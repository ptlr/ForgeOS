# <h1 align="center">015 硬盘及分区表</h1>

## 1、机械硬盘与分区

机械硬盘的结构影响了分区策略，因此需要详细了解机械硬盘的结构。

* 盘片

布满磁性介质的圆盘，类似光盘，每个盘片有上下两个面。

* 扇区

扇区是硬盘读写的基本单位，在磁道上均匀分布，扇区编号从1开始，扇区的大小字节数是256XN，N为自然数， 通常取2。

* 磁道

盘片上的一个个同心圆圈就是磁道，是扇区的载体。在老硬盘中内外磁道上的扇区数一样，但新硬盘外面磁道上的扇区数更多，通过地址转换来兼容老硬盘。

* 磁头

用于读取盘片上数据的磁头，一个盘面对应一个磁头，即一个盘片对应两个磁头。

* 柱面

硬盘是慢速设备，为了能更快的读写，根据并行的思想，采取多个盘片同读同写的方式进行数据存取，读写速度是磁头数或单盘数量的倍速。

这些不同盘片但磁道号相同的组成一个柱面。

* 分区

```
由多个编号连续的柱面组成的，在物理分区上表现为由某段范围内的所有柱面组成的同心圆环。
分区不能跨柱面，因此每个柱面的上存储的数据量就是分区粒度。
```

* 硬盘容量相关的计算

硬盘容量=每磁道扇区数 x 柱面数 x 512字节 x 磁头数

通常情况下，每磁道扇区数是63，扇区大小是512，因此，在硬盘容量已知的情况下：

柱面数 x 磁头数 = 硬盘容量 / 63 / 512

举例：

128MiB硬盘中，柱面数 x 磁头数 = 128MiB / 63 / 512 = 4161.015873016，根据具体配置得出柱面数和磁头数。

`在使用fdisk进行分区时，分区工具可能会对虚拟的磁盘进行扩容。`

## 2、分区表

分区是逻辑上划分磁盘空间的方式，各个分区都有`描述符`来记录硬盘上的起止界限信息。

起初，先行者认为每个机器山顶多安装四个操作系统，每个操作系统占一个分区，所以硬盘支持四个分区，因此在MBR中有一个64字节的`硬盘分区表(Disk Partion Table, DPT)`，每个表项16字节。

随着硬盘的容量越来越大，必须支持更多的扇区，因此有了主分区（Primary）、扩展分区（Extend）以及逻辑分区（Logic）,也因此引出了OBR，EBR。

* 主分区、扩展分区与逻辑分区

MBR中最多可记录四个分区信息，故`主分区数 + 扩展分区数 = 4`。

逻辑分区则属于扩展分区，即逻辑分区是扩展分区的子集。

### 2.1 主引导记录（Main Boot Record, MBR）

MBR是一段引导程序，其所在扇区称为`主引导扇区`,主引导扇区位于0盘0道1扇区（物理扇区从1开始，LBA从0开始）。

> 分区不能跨磁道和柱面，因此一般MBR会占一个磁道或一个柱面,因此，在单盘单面的磁盘中，MBR后第一个分区起始偏移一般为0x3F。

计算机通过自检后，将会加载着扇区并执行。

* 主引导扇区结构

| 位移          | 描述                                        |
|:-----------:| ----------------------------------------- |
| 0x000~0x1BD | MBR,共446字节，包括硬盘参数及部分指令，一般由分区工具产生，独立于操作系统。 |
| 0x1BE~0x1FD | DPT,共64字节，有四个表项，每个表现16字节。                 |
| 0x1FE~0x1FF | 主引导标志，2个字节，内容是魔数55AA。                     |

* 分区表项

| 偏移  | 数据宽度（字节） | 描述                                                                   | 备注  |
|:---:|:--------:| -------------------------------------------------------------------- | --- |
| 0   | 1        | 活动分区标记，取值x80或0x00。0x80表示活动分区，即引导扇区包含引导程序，可引导。0x00表示非活动分区，不可引导，其他值非法。 |     |
| 1   | 1        | 分区起始磁头号                                                              |     |
| 2   | 1        | 分区起始扇区号                                                              |     |
| 3   | 1        | 分区起始柱面号                                                              |     |
| 4   | 1        | 文件系统ID, 如0x00表示不可识别文件系统，0x01表示FAT32,0x83代表Linux/主分区，0x05代表扩展分区       |     |
| 5   | 1        | 分区结束磁头号                                                              |     |
| 6   | 1        | 分区结束扇区号                                                              |     |
| 7   | 1        | 分区结束柱面号                                                              |     |
| 8   | 4        | 分区起始偏移扇区                                                             |     |
| 12  | 4        | 分区容量扇区                                                               |     |

### 2.2 DOS引导扇区（DOS Boot Record, DBR）与操作系统引导记录（OS Boot Record, OBR）

起初，硬盘的四个分区都被称为DBR，他们位于每个分区的第一个扇区，当他们最后两个字节是魔数为0x55AA时，MBR认为这个分区有操作系统。

后来为UINX, Linux为了兼容MBR也传承了这个习俗，由于DOS退出舞台，DBR现在被称为操作系统引导记录（OS Boot Record, OBR）。

OBR可以位于主分区或逻辑分区的第一个扇区，不包含分区表，用于操作系统的启动。

> 注意：操作系统文件可以放在逻辑分区或扩展分区，但用于引导的文件需要放在主引导分区，因此，必须有一个主分区。

### 2.3 扩展引导分区（Extend Boot Record, EBR）

结构与MBR相同，由分区工具创建，操作系统一般不对EBR进行操作。

EBR的DPT中只有两个表项，第一个表项是自身分区的信息，第二个表项则是下一个分区表的信息。

需要注意的是，第二个表项的分区起始偏移扇区LBA是相对于扩展分区而言的。

> 因此，逻辑分区的绝对LBA = 总扩展分区的绝对LBA + 逻辑分区偏移扇区
