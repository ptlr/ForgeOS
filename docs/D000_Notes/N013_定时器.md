# <h1 align="center">定时器</h1>

* 了解时钟

* 了解计数器

* 了解定时器8253

## 1 时钟

在计算机系统中，为了使设备之间的通信井然有序，需要统一的节奏，这个节奏就叫定时或时钟。

在计算机中，时钟大致可以分成两类，内部时钟和外部时钟。

### 1.1 内部时钟

是处理器内部元件，用于控制、同步内部工作过程的步调。他有内部晶体震荡产生，该晶振处于主板，其评率经过分屏后作为主板外频，用于处理器和主板上的元件通信，外频的乘以某个倍数（倍频）后称为主频。主频出厂时就设置好，无法改变。此外，现代的CPU时钟精度都比较高，通常是纳秒(ns)级。

### 1.2 外部时钟

指处理器与外部设备或外部设备之间通信采用的一种时序。时间精度比较低，一般是毫秒（ms）甚至是秒（s）。

为了设备之间有序的进行协作，需要以处理器的内部时钟为依据来设计外部时钟。

由晶振产生的频率过高，必须把信号发送到`定时器`分频，这样才能产生各种所需要的信号。

定时器用来定时发出信号，定时器分成`不可编程定时器`和`可编程定时器(PIT, programable Interval Timer)`两种。在学习和开发操作系统的过程中，主要接触PIT,其代码表是Intel 8253。

对于外部定时器，一般有`软件实现`和`硬件实现`两种。

#### 1.2.1 软件实现

通常使用空循环来实现等待一段时间，但受到CPU运行速度影响，需要根据CPU的能力进行调整。

```c
int cycleCnt = 9000;
while(cycleCnt-- > 0);
```

在汇编语言中，也有类似的操作，比如：

```nasm
.notReady:
    nop
    nop
    inc al
    cmp al, 9000
    je .notReady
    ;...
```

#### 1.2.2 硬件实现

硬件实现不依赖CPU,因此不占用CPU资源，也不受CPU影响，可以大大提升CPU的利用效率。

### 1.3 计数器简介

计数器为其他元件提供稳定的工作节拍，自己本身也必须可靠。

因此计数器有自己的`时钟脉冲信号`，也叫`计数脉冲信号`，每次`时钟脉冲信号`到来就会修改计数值。

硬件计时一般有`正计时`和`倒计时`两种。

* 正计时

每次脉冲信号到来，计数值加1，直到与目标值相同。

* 倒计时

每次脉冲信号到来，计数值减1，直到计数值为0。

## 2 Intel 8253

### 2.1 Intel 8253简介

8253内部有三个独立的计数器，又可以称为通道，编号从计数器0至计数器2，对应的地址端口是0x40~0x42。

在个人计算机中这三个计数器都有自己的作用：

| 计数器  | 端口   | 作用                                                        |
| ---- | ---- | --------------------------------------------------------- |
| 计数器0 | 0x40 | 用于产生实时时钟信号。采用工作方式3，计数初始值为0时表示最大数值65536。0x20号中断响应这个计数器。    |
| 计数器1 | 0x41 | 专用于DRAM的定时刷新控制。PC/XT规定在2ms内进行128次刷新。PC/AT规定在4ms内进行256次刷新。 |
| 计数器2 | 0x42 | 专用于内部扬声器发出不同音调的声音（向扬声器发送不同频率的方波）                          |

每个计数器都有自己的一套寄存器资源，详情如下：

| 寄存器     | 作用                            | 备注  |
| ------- | ----------------------------- | --- |
| 计数初值寄存器 | 保存计数器的初始值，即初始化时写入的值           |     |
| 减法计数器   | 用于计数器计数。从计数初值寄存器拿到初始值吗，开始递减计数 |     |
| 输出锁存器   | 把当前减法计数器中的值保存下来，方便外界需要时读取计数值  |     |

此外，每个寄存器还有三个重要引脚：

| 引脚   | 作用                                     |
| ---- | -------------------------------------- |
| CLK  | 为计数器输入时钟信号，即计数器的时钟；8253的时钟频率为1193180Hz |
| GATE | 门输入控制信号，某些工作方式下用与控制计数是否开始计数            |
| OUT  | 计数器输出信号。每当计数器为0的时候，根据计数器的方式输出信号        |

### 2.2 Intel 8253控制字

除了需要初始化8253的计数初始值，还需要初始化8253的工作方式。

三个计数器共用一个控制字端口0x43，它是一个8位寄存器。

| 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| SC1 | SC0 | RW1 | RW0 | M2  | M1  | M0  | BCD |

* 7~6位用来选择要初始的计数器

| 值   | 对应的计数器 |
| --- | ------ |
| 00  | 计数器0   |
| 01  | 计数器1   |
| 10  | 计数器2   |
| 11  | 未定义    |

* 5~4是RW位（Read/Write/Latch）用来设置待操作计数器的读写与锁存方式

| 值   | 读写或锁存方式       |
| --- | ------------- |
| 00  | 锁存数据，只供CPU读取  |
| 01  | 只读写低字节        |
| 10  | 只读写高字节        |
| 11  | 先读写低字节，再读写高字节 |

* 3~1位是工作模式位，用于选择工作模式,详情见Intel 8253工作方式

* 0位BCD位，用来表示计数器的计数方式是BCD码还是二进制方式

置1时表示BCD表示，范围从0~9999,0表示10000;置1时表示二进制表示，范围0~65535,0表示65536。

### 2.3 Intel 8253工作方式

| 值   | 工作方式 | 描述                                         | 启动方式        | 终止计数方法 | 循环计数 | 特点                   |
| --- | ---- | ------------------------------------------ | ----------- | ------ | ---- | -------------------- |
| 000 | 方式0  | 计数结束中断方式（Interrupt on Terminal Count）      | 写入初始值（软件）   | GATE=0 | 否    | 用来实现定时器或对外部事件计数      |
| 001 | 方式1  | 硬件可重复单稳方式（HardWare Retriggerable One-Shot） | GATE上升沿（硬件） | ----   | 否    | 用来生产单稳脉冲             |
| x10 | 方式2  | 比率发生器（Rate Generator）                      | 写入初始值（软件）   | GATE=0 | 是    | 用来实现对时钟脉冲CLK的N分频     |
| x11 | 方式3  | 方波发生器（Square Wave Generator）               | 写入初始值（软件）   | GATE=0 | 是    | 用来产生连续方波或时钟脉冲CLK的N分频 |
| 100 | 方式4  | 软件触发选通（Software Triggered Strobe）          | 写入初始值（软件）   | GATE=0 | 否    | ----                 |
| 101 | 方式5  | 硬件触发选通（HardWare Triggered Strobe）          | GATE上升沿（硬件） | ----   | 否    | ----                 |

`在写入计数值后，方式0中OUT引脚电平为0，其它方式电平为1`

#### 2.3.1 计数开始方式

计数器开始计数需要两个条件：

（1）GATE为高电平（GATE置1）

（2）计数值写入计数器的减法计数器中（OUT指令控制）

根据那个条件最后完成，分成`软件启动`和`硬件启动`：

（1）软件启动

GATE置1，只差计数初始值写入完成就开始计数。

（2）硬件启动

计数器初始值已经写入完成，当GATE=0时，表示准备完成，在GATE上升沿（电平0至1的瞬间）开始计数。

#### 2.3.2 计数终止方式

（1）强制终止

破坏计数器的启动条件，将GATE置为0。

（2）自动终止

某些工作模式，计数器处于单次计数模式，当计数值为0后自动停止，途中想要停止请使用`强制终止`

### 2.4 Intel 8253初始化步骤

（1）往控制字寄存器端口0x43写入控制字

（2）往对应的计数器端口写入计数初值

计数器初始化值是16位，但高8位和低8位可以独立使用，若初值为8位，直接往端口写入即可，若初值为16位，需要先写低8位，在写高8位。

### 2.5 分频计算

时钟频率 / 计数器的初始值 = 中断信号频率

----

参考资料

【书】 操作系统真相还原 郑刚 第7.7~7.8节
