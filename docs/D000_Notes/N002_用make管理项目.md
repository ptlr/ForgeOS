# <h1 align="center">用make管理项目</h1>

## 一、学习目标

* [ ] 了解项make与makefile
* [ ] makefile基础

## 二、笔记内容

当一个项目大到一定程度，手动编译和手动管理并不在便利，因此需要借助工具来管理项目，像QT程序有qmake管理，安卓程序有gradle管理，rust项目由cargo管理一样。

在学习和开发操作系统的过程中选择使用make进行管理，也可以选择自己熟悉的管理工具。

### 1、make与makefile

make是项目管理程序，它的运行需要项目的依赖规则和运行方式，这些内容保存在makefile中。

make和makefile一起使用就能十分方便的管理项目。

```bash
# 最简单的命令
make
```

上面这条命令会执行makefile文件中最上面的一条编译规则。

* make 也可以通过`-f`指定makefile,如果不指定则会按`GUNmake`、`makefile`、`Makefile`的顺序查找，最新找到哪个用哪个。

* 编译时也可以用`-j`指定编译该项目使用的线程数:

```bash
# 使用四个线程编译项目
make -j4
```

* makefile也可以通过`include`指令包含其他`makefile`

```makefile
# 包含boot.mk
include boot.mk
```

### 2、makefile基础

#### （1）变量

make的变量大体上分成三种`自定义变量`、`系统变量`、`自动变量`：

|  变量类型  | 描述                                            | 备注 |
| :--------: | ----------------------------------------------- | ---- |
| 自定义变量 | 一些自己定义的变量                              |      |
|  系统变量  | make自带的变量，带有默认值，比如CC变量指c编译器 |      |
|  自动变量  | 代表一组文件名，比如依赖文件，目标文件。        |      |

* 系统变量

| 变量名  | 描述                       | 备注 |
| :-----: | -------------------------- | ---- |
|   AS    | 汇编编译器，默认编译器是as |      |
|   CC    | C编译器，默认编译器是cc    |      |
|   LD    | 链接器，默认值是ld         |      |
|   RM    | 删除命令，默认值是“rm -f”  |      |
| ASFLAGS | 汇编语言编译器参数         |      |
| CFLAGS  | C语言汇编编译器参数        |      |
| LDFLAGS | 连接器参数                 |      |

* 自动变量

| 助记符号 | 描述                 | 备注 |
| :------: | -------------------- | ---- |
|    $@    | 表示目标文件名集合   |      |
|    $<    | 依赖文件的第一个文件 |      |
|    $^    | 表示所有依赖文件     |      |

* 变量的定义、使用

```makefile
# 系统变量, =是最基本的赋值，值的结果将会在makefile文件展开后决定
# '#'开头的行是注释行
CC =gcc
# 自定义变量
mVal =Hello
# :=会覆盖之前的值，而且值会在当前行的位置被赋值
mVal :=World
#此时mVal=World!!
mVal +=!!
# mVal如果没有被赋值则会赋给=号后面的值
mVal ?= 512
# 此处$@=boot.o，$< = boot.asm
boot.o:boot.asm
	nasm -o $@ $<
# 通过$(变量名)来使用定义号的变量
# 下面这条命令应该输出：World!!
	echo $(mVal)
```

#### （2）基本语法

* makefile的基本语法

```makefile
目标文件:依赖文件
[TAB]命令3
[TAB]命令2
```

* 目标文件是想要生成的文件
* 依赖文件是执行规则是需要的文件
* 命令前面需要用<kbd>TAB</kbd>开头，可以有多行命令

make支持生成目标文件的目标，称之为`伪目标`，可以使用`.PHONY:`命令指出为目标，使用时用`make xxx`执行xxx处的目标。

常用的伪目标名称如下：

* all : 编译所有
* build: 编译
* clean: 清理项目
* 其他（run , install）

实例：

```makefile
# 声明all build run clen为伪目标
.PHONY: all build run clean
all:
	echo "xxx"
	
clean:
	rm -f *.o
```
